<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu promeiro jogo multisquere</title>
    <link rel="stylesheet" href="./src/style/main.css">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
    <canvas id="screen" width="10" height="10">

    </canvas>

    <script type="module">
      
        import createGame from "./game.js"
        import createKeydownListenner from "./keyboardListenner.js"
        import renderstate from "./renderstate.js"


        const canvas = document.querySelector("#screen")
   
        const contextScreen = canvas.getContext('2d')
 
        
        const gameClient = createGame()
        
        const socket = io();

        const keyboardListener = createKeydownListenner()
        
        socket.on('connect', () => {
            const playerId = socket.id
            console.log("client conneted with id: ", playerId)
            
            
            keyboardListener.setPlayerId(playerId) //definir player
            keyboardListener.subscribe(gameClient.movePlayer) //inscrever a movimentação do player
            keyboardListener.subscribe((command) => {
                socket.emit(command.type, command)
            })

            renderstate(contextScreen, gameClient, playerId)
        })

        socket.on('setup', (state) => {
            console.log("> setup in the game completed")
            gameClient.setState(state)

        })

        //receber sinais do servidor
        socket.on('add-player', (command) => {
            console.log('receivid signal with id ', command.type)
            gameClient.addPlayer(command)
        })

        //sinal de player desconected
        socket.on('remove-player', (command) => {
            console.log('received signal with id: ', command.id)
            gameClient.removePlayer(command)
        })

        //move player
        socket.on('move-player', (command) => {
            const playerId = socket.id
          
            if (playerId !== command.playerId) {
                gameClient.movePlayer(command)
            }
        })

        //add fruits

        socket.on('add-fruit', (command) => {
            gameClient.addFruit(command)
        })

        socket.on('fruit-colleted', (command) => {
            
        })

        socket.on('update', (state) => {
            console.log("update ", state)
        }, 100)

        

    </script>
</body>
</html>